jQuery(document).ready(function(e){e("#comments-section").load("./templates/comments-content.html",function(){var t,n=document.getElementById("comments"),o=document.getElementById("comments-counter"),i=0,c=0,r=document.getElementById("user-avatar"),m="http://frontend-test.pingbull.com/pages/vadim.orlov.workmail@gmail.com/comments";function l(e,t){var n,o;for(["matches","webkitMatchesSelector","mozMatchesSelector","msMatchesSelector","oMatchesSelector"].some(function(e){return"function"==typeof document.body[e]&&(n=e,!0)});e;){if((o=e.parentElement)&&o[n](t))return o;e=o}return null}function a(e,n,o){var i,c,r=(i=e.created_at,c=new Object,s=i.toLowerCase(),c.d=s.substring(0,s.indexOf("t")),c.t=s.substring(s.indexOf("t")+1,s.lastIndexOf(":")),c),m="";e.author.id===t.id?m+='<div class="comment__navigation clearfix flex"><button class="comment__nav-button comment__nav-button_edit stag-book small-font" data-action="edit" onclick="replyForm.dislocate(this)">Edit</button> <button class="comment__nav-button comment__nav-button_delete stag-book small-font" data-action="delete" onclick="deleteComment(this)">Delete</button> '+(!1===o?'<button class="comment__nav-button comment__nav-button_reply stag-book small-font" data-action="reply" onclick="replyForm.dislocate(this)">Reply</button> ':" ")+"</div> ":!1===o&&(m+='<div class="comment__navigation clearfix flex"><button class="comment__nav-button comment__nav-button_reply stag-book small-font" data-action="reply" onclick="replyForm.dislocate(this)">Reply</button> </div> ');var l=document.createElement("div");return l.classList="comment"+(o?" comment_reply":" comment_parent"),l.setAttribute("data-user-id",e.author.id),l.setAttribute("id",e.id),l.innerHTML='<div class="avatar border border_narrow rounded'+(o?" avatar_small":"")+'"><img class="block rounded" src="'+e.author.avatar+'" alt="avatar"> </div> <div class="comment__wrapper"><ul class="info info_comment"><li class="info__item info__item_author"><p class="info__author-name stag-medium medium-font">'+e.author.name+"</p> </li> "+(o?'<li class="info__item info__item_addressee"><div class="info__icon"><img src="./img/addressee.png" alt="icon"></div> <p class="info__addressee-name stag-book small-font">'+n+"</p> </li> ":"")+'<li class="info__item info__item_date small-font"><div class="info__icon"><img src="./img/clock.png" alt="icon"></div> <time class="stag-medium">'+r.d+' </time> <p class="stag-book"> at</p> <time class="stag-medium"> '+r.t+'</time> </li> </ul> <p class="comment__message medium-font stag-book">'+e.content+"</p> "+m+'</div> <div class="comment__reply" id="reply-'+e.id+'"></div> <div class="comment__replies"></div>',l}function d(e){for(var t=0,o=e.length;t<o;t++){var s=a(e[t],!1,!1);if(n.append(s),e[t].children.length)for(var i=s.querySelector(".comment__replies"),c=0,r=e[t].children.length;c<r;c++)i.append(a(e[t].children[c],e[t].author.name,!0))}}function u(t,n,s,i,c,r){e.ajax({url:m+n,type:t,data:i}).done(function(e){c&&"string"==typeof c&&"DELETE"!=t&&"DELETE"!=s&&window[c](e),("DELETE"===t||"POST"===t&&"DELETE"===s)&&(document.getElementById(c).parentNode.removeChild(document.getElementById(c)),o.innerHTML=parseInt(o.innerHTML)-1+" comments")}).fail(function(e,o){if(r)return!1;s=t="PUT",i._method=s,u(t="POST",n,s,i,c,!0)})}function h(e){"respond-form"===e.getAttribute("id")?(this.el=e.cloneNode(!0),this.addressee=this.el.querySelector("#addressee"),this.close=this.el.querySelector("#close"),this.setParams=function(e,t){this.action=e.getAttribute("data-action"),this.comment=l(e,".comment"),this.ref=this.comment.querySelector(".comment__reply"),this.parent=l(this.ref,".comment.comment_parent"),this.addressee_name=this.parent.querySelector(".info__author-name").textContent,this.addressee_id=this.parent.getAttribute("id")}.bind(this),this.dislocate=function(e){this.formReset(),this.setParams(e),this.addressee.innerHTML=this.addressee_name,"edit"===this.action&&(this.input.value=this.comment.querySelector(".comment__message").textContent),this.ref.appendChild(this.el)}.bind(this),this.formReset=function(){this.input.value=this.addressee.innerHTML="",this.processStatus(!1,!1)}.bind(this),this.close.onclick=function(){this.ref&&this.ref.removeChild(this.el),this.formReset()}.bind(this)):(this.el=e,this.action="post"),this.input=this.el.querySelector(".comment-form__input"),this.button=this.el.querySelector(".comment-form__button"),this.error=this.el.querySelector(".comment-form__error"),this.success=this.el.querySelector(".comment-form__success"),this.button.onclick=function(e){e.preventDefault(),this.validateInput(this.input.value)?"post"===this.action?u("POST","",!1,{content:this.input.value,parent:null},"successfulPost",!1):"edit"===this.action?u("PUT","/"+l(this.el,".comment").getAttribute("id"),!1,{content:this.input.value},"successfulEdit",!1):"reply"===this.action&&u("POST","",!1,{content:this.input.value,parent:l(this.el,".comment").getAttribute("id")},"successfulReply",!1):this.processStatus(!0,!1,'Please, type your message and click "Send"!')}.bind(this)}window.countComments=function(e){for(var t=0,n=e.length;t<n;t++)i+=1+(e[t].children.length||0);o.innerHTML=i+" comments"},window.startSetup=function(e){c+=e.length,t={id:e[0].author.id,name:e[0].author.name,avatar:e[0].author.avatar},r.src=t.avatar,d(e)},u("GET","",!1,{count:5,offset:c},"startSetup",!1),u("GET","",!1,{offset:0,count:1e3},"countComments",!1),h.prototype.validateInput=function(e){return!!e.length},h.prototype.processStatus=function(e,t,n){e?(this.error.innerHTML=n,this.success.classList.remove("comment-form__success_active"),this.error.classList.add("comment-form__error_active")):t?(this.success.innerHTML=n,this.error.classList.remove("comment-form__error_active"),this.success.classList.add("comment-form__success_active"),setTimeout(function(){this.success.classList.remove("comment-form__success_active")}.bind(this),2e3)):(this.error.classList.remove("comment-form__error_active"),this.success.classList.remove("comment-form__success_active"))},window.replyForm=new h(document.getElementById("respond-form").cloneNode(!0)),window.commentForm=new h(document.getElementById("comment-form")),window.deleteOverlay={el:document.getElementById("delete-overlay").cloneNode(!0)},document.getElementById("comments-section").removeChild(document.getElementById("form-container")),deleteOverlay.accept=deleteOverlay.el.querySelector("#accept"),deleteOverlay.abort=deleteOverlay.el.querySelector("#abort"),deleteOverlay.accept.onclick=function(){var e=l(deleteOverlay.el,".comment").getAttribute("id");u("DELETE","/"+e,!1,{},e,!1)},deleteOverlay.abort.onclick=function(){l(deleteOverlay.el,".comment").querySelector(".comment__wrapper").removeChild(deleteOverlay.el)},window.successfulPost=function(e){commentForm.input.value="",document.getElementById("comments").insertBefore(a(e,!1,!1),document.getElementById("comments").firstChild),o.innerHTML=parseInt(o.innerHTML)+1+" comments",commentForm.processStatus(!1,!0,"Your message has been succesfully added:)")},window.successfulEdit=function(e){document.getElementById(e.id).querySelector(".comment__message").innerHTML=e.content,replyForm.processStatus(!1,!0,"Changed successfully!"),setTimeout(function(){replyForm.ref.removeChild(replyForm.el)},2e3)},window.successfulReply=function(e){var t=a(e,replyForm.addressee_name,!0);replyForm.parent.querySelector(".comment__replies").append(t),replyForm.processStatus(!1,!0,"Your answer has been added!"),o.innerHTML=parseInt(o.innerHTML)+1+" comments",setTimeout(function(){replyForm.ref.removeChild(replyForm.el)},2e3)},window.deleteComment=function(e){l(e,".comment").querySelector(".comment__wrapper").appendChild(deleteOverlay.el)},window.loadComments=function(e){e.length?(e.length<4&&(f.innerHTML="no more comments",f.onclick=null,f.setAttribute("disabled","true")),c+=e.length,d(e)):(f.innerHTML="no more comments",f.onclick=null,f.setAttribute("disabled","true"))};var f=document.getElementById("load-more");f.onclick=function(){u("GET","",!1,{count:5,offset:c},"loadComments",!1)};for(var _=document.querySelectorAll(".post__content-image"),p=document.getElementById("image-zoom"),v=document.getElementById("zoom-img"),y=0,g=_.length;y<g;y++)_[y].onclick=function(e){v.src=this.querySelector("img").getAttribute("src"),p.classList.add("active"),document.querySelector("html").classList.add("noscroll")};p.onclick=function(){this.classList.remove("active"),document.querySelector("html").classList.remove("noscroll")}})});
